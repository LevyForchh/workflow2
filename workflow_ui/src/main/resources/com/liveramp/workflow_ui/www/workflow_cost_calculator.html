<!DOCTYPE html>
<html>
<head lang="en">
  <link rel="shortcut icon" href="images/favicon.ico">
  <meta charset="UTF-8">
  <title>Slot Machine</title>

  <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="css/workflow_calculator.css">
  <link rel="stylesheet" type="text/css" href="css/jquery-ui.min.css">
  <link rel="stylesheet" type="text/css" href="css/jquery-ui.structure.min.css">
  <link rel="stylesheet" type="text/css" href="css/jquery-ui.theme.min.css">
  <link rel="stylesheet" type="text/css" href="css/c3-0.4.10.min.css">
  <link rel="stylesheet" type="text/css" href="css/tablesorter-style.css">

  <script type="text/javascript" src="resources/jquery-2.1.1.min.js"></script>
  <script type="text/javascript" src="resources/jquery.cookie.js"></script>
  <script type="text/javascript" src="resources/moment-with-langs.min.js"></script>
  <script type="text/javascript" src="resources/d3.min.js" charset="utf-8"></script>
  <script type="text/javascript" src="resources/dagre-d3.min.js"></script>
  <script type="text/javascript" src="resources/uri.min.js"></script>
  <script type="text/javascript" src="resources/bootbox.min.js"></script>
  <script type="text/javascript" src="resources/underscore-min.js"></script>
  <script type="text/javascript" src="resources/jquery-ui.min.js"></script>
  <script type="text/javascript" src="resources/bootstrap.min.js"></script>
  <script type="text/javascript" src="resources/c3-0.4.10.min.js"></script>
  <script type="text/javascript" src="resources/jquery.tablesorter.min.js"></script>

  <script type="text/javascript" src="js/common.js"></script>

  <script src="js/jquery.easing.1.3.js" type="text/javascript" charset="utf-8"></script>
  <script src="js/jquery.jSlots.js" type="text/javascript" charset="utf-8"></script>

  <style type="text/css">
    /* Temprorary stuff for slot machine effects. To be removed after Hackweek presentations*/
    ul {
      padding: 0;
      margin: 0;
      list-style: none;
    }

    .jSlots-wrapper {
      overflow: hidden;
      height: 20px;
      display: inline-block; /* to size correctly, can use float too, or width*/
    }

    .slot {
      float: left;
    }

    input[type="button"] {
      display: block;
    }

    /* ---------------------------------------------------------------------
    FANCY EXAMPLE
    --------------------------------------------------------------------- */
    .fancy .jSlots-wrapper {
      overflow: hidden;
      height: 100px;
      display: inline-block; /* to size correctly, can use float too, or width*/
    }

    .fancy .slot li {
      width: 100px;
      line-height: 100px;
      text-align: center;
      font-size: 70px;
      font-weight: bold;
      color: #fff;
      text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.8);
      font-family: 'Gravitas One', serif;
      border-left: 1px solid #999;
    }

    .fancy .slot:first-child li {
      border-left: none;
    }

    .fancy .slot li:nth-child(9) {
      background-color: #ADD8E6;
    }

    .fancy .slot li:nth-child(8) {
      background-color: #C0D890;
    }

    .fancy .slot li:nth-child(6),
    .fancy .slot li:nth-child(10) {
      background-color: #C0D890;
    }

    .fancy .slot li:nth-child(5) {
      background-color: #ADD8E6;
    }

    .fancy .slot li:nth-child(4) {
      background-color: #C0D890;
    }

    .fancy .slot li:nth-child(3) {
      background-color: #ADD8E6;
    }

    .fancy .slot li:nth-child(2) {
      background-color: #C0D890;
    }

    .fancy .slot li:nth-child(1),
    .fancy .slot li:nth-child(7) {
      background-color: #ADD8E6;
    }

    .fancy .slot li span {
      display: block;
    }

  </style>
</head>
<body>

<div id="navbar"></div>
<script>
  configureNavbar($("#navbar"))
</script>

<div class="container-fluid service-container">
  <div class="row">
    <div class="col-md-8">
      <div class="panel panel-default">
        <div class="panel-heading">
          The calculator is currently preconfigured with a sample date range of:
          <div id="settings-message"></div>
          <br>
          <button type="button" class="btn btn-default btn-xs spoiler-trigger" data-toggle="collapse">Advanced
            Settings
          </button>
        </div>
        <div class="panel-collapse collapse out">
          <div class="panel-body">
            <div class="sampling-date-range">
              <label>Sampling Date Range</label>
              From:
              <label for="absolute-start-date"></label>
              <input type="text" id="absolute-start-date" readonly='true'>
              Until:
              <label for="absolute-end-date"></label>
              <input type="text" id="absolute-end-date" readonly='true'>
            </div>
            <div>
              <label data-toggle="tooltip" data-placement="top" title="Number of slots per machine">Slot
                To Machine
                Ratio</label>
              <input id="slot-machine-ratio" type="number" value="32"> slots per machine
            </div>
            <div>
              <label data-toggle="tooltip" data-placement="top"
                     title="Number of machines during sampling to help determine a calibration ratio">Machine
                Count for
                Calibration</label>
              <input id="calibration-machine-count" type="number" value="500"> machines
            </div>
            <div>
              <label data-toggle="tooltip" data-placement="top"
                     title="How much of the cluster will actually be utilized"> Desired Utilization of
                Cluster</label>
              <input id="utilization-ratio" type="number" value="100">%
            </div>
          </div>
        </div>
      </div>

      <form method="GET" id="cic_form">
        <table class="table fixed-width-table tablesorter calculator-costs table-striped">
          <thead>
          <tr>
            <th id="wf" class="col-md-1">Workflow</th>
            <th id="freq" class="col-md-4">Execution Frequency</th>
            <th id="shpe" class="col-md-3">Slot Hours / Execution</th>
            <th id="cost" class="col-md-2">Kilo Slot Hours</th>
          </tr>
          </thead>

          <tbody id="calc-inputs">

          </tbody>
        </table>
      </form>
    </div>
    <div class="col-md-4">
      <br>

      <div class="fancy" align="center">
        <ul class="slot">
          <!-- In reverse order so the 7s show on load -->
          <li><span>0</span></li>
          <li><span>1</span></li>
          <li><span>2</span></li>
          <li><span>3</span></li>
          <li><span>4</span></li>
          <li><span>5</span></li>
          <li><span>6</span></li>
          <li><span>7</span></li>
          <li><span>8</span></li>
          <li><span>9</span></li>
        </ul>
        <input type="button" id="playBtn" value="Play" style="display: none;">
      </div>
      <br>

      <div id="slots-hours-needed" style="display: none;"> Slots</div>
      <div class="machines-needed">
        <h4>Machines Needed</h4>
        <table class="table">
          <tr>
            <th></th>
            <th data-toggle="tooltip" data-placement="top"
                title="The number of machines the calculator thinks you will need">Calculated
            </th>
            <th data-toggle="tooltip" data-placement="top"
                title="The number of machines after a calibration ratio is factored in">Calibrated
            </th>
            <th data-toggle="tooltip" data-placement="top"
                title="The number of machines after a utilization buffer is included">Buffer
            </th>
          </tr>
          <tr>
            <td>Machines</td>
            <td id="machines-calculated"></td>
            <td id="machines-calibrated"></td>
            <td id="machines-utilization"></td>
          </tr>
        </table>
      </div>
      <br>
      <!--div>The chart provides estimated # of machines required vs. # of executions of the selected
        workflow (with all other values from the table on the left).</div-->
      <br>

      <div id="machines-needed-plot"></div>
      <div id="workflow-name" align="center"></div>

    </div>
    <div class="col-md-1"></div>
  </div>
</div>

<script>
  var slotObject;

  $(document).ready(function () {
    slotObject = $('.slot').jSlots({
      spinner: '#playBtn',
      time: 1000,
      endNumbers: [1, 2, 3],
      loops: 1,
    });
  });

  function spinSlotMachine(numOfMachines) {
    slotObject.options.endNumbers = getArray(numOfMachines);
  }
  ;

  /*
   // fancy example
   $('.fancy .slot').jSlots({
   number : 7,
   winnerNumber : 1,
   spinner : '#playFancy',
   easing : 'easeOutSine',
   time : 7000,
   loops : 6,
   onStart : function() {
   $('.slot').removeClass('winner');
   },
   onWin : function(winCount, winners) {
   // only fires if you win

   $.each(winners, function() {
   this.addClass('winner');
   });
   // react to the # of winning slots
   if ( winCount === 1 ) {
   //alert('You got ' + winCount + ' 7!!!');
   } else if ( winCount > 1 ) {
   //alert('You got ' + winCount + ' 7â€™s!!!');
   }

   }
   }); */

  TIME_CONVERT = {
    hour: 1,
    day: 24,
    week: 168,
    month: 720
  };

  configs = {};

  $.tablesorter.addParser({
    id: 'frequency',
    is: function (s) {
      return false;
    },
    format: function (s, table, cell) {
      var selectElement = cell.getElementsByTagName("select")[0];
      var frequency = cell.childNodes[0].value;
      var timeFrame = selectElement.options[selectElement.selectedIndex].value;
      return parseFloat(frequency / TIME_CONVERT[timeFrame]);
    },
    type: 'numeric'
  });

  $.tablesorter.addParser({
    id: 'shpe',
    is: function (s) {
      return false;
    },
    format: function (s, table, cell) {
      return parseFloat(cell.childNodes[0].value);
    },
    type: 'numeric'
  });

  function getTotalSlots() {
    var elements = document.getElementById("cic_form").elements;
    var slotCounter = 0;

    for (var i = 0; i < elements.length - 1; i += 3) {
      var exeCount = elements[i].value;
      var exeTimeFrame = elements[i + 1].value;
      var slotHoursPerExecution = elements[i + 2].value;

      slotCounter += exeCount * slotHoursPerExecution / (TIME_CONVERT[exeTimeFrame]);
    }
    return slotCounter;
  }

  function getArray(num) {
    return num.toString(10).split("").map(function (t) {
      return parseInt(t) + 1
    });
  }

  function saveRowConfig(rowElement, element, id) {
    var value;
    if (id == "time-frame") {
      value = element.value;
    } else {
      value = parseFloat(element.value);
    }
    var workflowName = rowElement.getElementsByTagName("td").item(0).textContent;
    if (!configs[workflowName]) {
      configs[workflowName] = {};
    }
    configs[workflowName][id] = value;
    updateConfigsInUrl(configs);
  }

  function getParameterByName(name) {
    var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
    return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
  }

  function updateConfigsInUrl(jsonConfigs) {
    if (typeof (history.pushState) != "undefined") {
      var url = document.URL;
      if (url.indexOf("?") > -1) {
        url = url.substr(0, url.indexOf("?"));
      }
      newUrl = url + "?" + "configs=" + JSON.stringify(jsonConfigs);
      if (newUrl.length >= 2048) {
        alert("Too many configs; cannot save to URL!");
      }
      var obj = {Title: "title", Url: newUrl};
      history.pushState(obj, obj.Title, obj.Url);
    } else {
      alert("Browser does not support HTML5.");
    }
  }

  function calculateResources() {
    var slotCounter = getTotalSlots();
    document.getElementById('slots-hours-needed').innerHTML = slotCounter.toFixed(0) + " Slots";
    document.getElementById('machines-calculated').innerHTML = getMachineCount(slotCounter);
    updateMachineTable();
  }

  function updateCalculationResults(rowElement, source) {
    //@TODO: avoid depending on DOM for plot data
    var executionFreqElement = rowElement.getElementsByTagName("td")[1];
    var selectElement = executionFreqElement.getElementsByTagName("select")[0];
    var shpeElement = rowElement.getElementsByTagName("td")[2]; //shpe - slot hours per execution

//    changeFrequency(selectElement); //disabled to make room for auto changing
    var timeFrame = selectElement.options[selectElement.selectedIndex].value;

    var slotHoursPerExecution = parseFloat(shpeElement.childNodes[0].value);
    var frequency = parseFloat(executionFreqElement.childNodes[0].value);

    var slotCounter = getTotalSlots();

    document.getElementById('slots-hours-needed').innerHTML = slotCounter.toFixed(0) + " Slots";
    document.getElementById('machines-calculated').innerHTML = getMachineCount(slotCounter);
    updateMachineTable();

    //var calculatedSlots = parseInt($('#slots-hours-needed').text());


    if (source == "frequency") {
      var executions = ['executions'];
      var predictedMachines = ['machines'];
      var axesIdx = 1;

      var step_factor = 0.1;
      var max_factor = 2;
      var lower = -0.5 * (max_factor - 1) / step_factor;
      var upper = (max_factor - 1) / step_factor;

      for (var i = -5; i <= (max_factor - 1) / step_factor; i++) {
        var predFreq = frequency * (1 + i * step_factor);
        var predSlots = slotCounter;
        predSlots = predSlots + (predFreq - frequency) * slotHoursPerExecution / (TIME_CONVERT[timeFrame]);

        var noOfMachines = getMachineCount(predSlots);
        predictedMachines[axesIdx] = noOfMachines;
        executions[axesIdx] = predFreq.toFixed(2);
        axesIdx += 1;
      }

      var chart = c3.generate({
        bindto: '#machines-needed-plot',
        data: {
          x: 'executions',
          columns: [
            executions,
            predictedMachines,
          ],
          selection: {
            enabled: true
          }
        },
        axis: {
          x: {
            label: 'Execution frequency (per ' + timeFrame + ')',
          },
          y: {
            label: 'Machines needed',
            tick: {
              format: d3.format('d')
            }
          },
        },
        padding: {
          right: 20,
        },
      });
    } else {
      var shpe = ['shpe'];
      var predictedMachines = ['machines'];
      var axesIdx = 1;

      var step_factor = 0.1;
      var max_factor = 2;
      var lower = -0.5 * (max_factor - 1) / step_factor;
      var upper = (max_factor - 1) / step_factor;

      for (var i = lower; i <= upper; i++) {
        var predShpe = slotHoursPerExecution * (1 + i * step_factor);
        var predSlots = slotCounter;
        predSlots = predSlots + (frequency) * (predShpe - slotHoursPerExecution) / (TIME_CONVERT[timeFrame]);

        var noOfMachines = getMachineCount(predSlots);
        predictedMachines[axesIdx] = noOfMachines;
        shpe[axesIdx] = parseInt(predShpe);
        axesIdx += 1;
      }

      var chart = c3.generate({
        bindto: '#machines-needed-plot',
        data: {
          x: 'shpe',
          columns: [
            shpe,
            predictedMachines,
          ],
          selection: {
            enabled: true
          }
        },
        axis: {
          x: {
            label: 'Slot hours per execution',
          },
          y: {
            label: 'Machines needed',
            tick: {
              format: d3.format('d')
            }
          },
        },
        padding: {
          right: 20,
        },
      });
    }

    chart.select(['machines'], [5]);
    chart.legend.hide();

    document.getElementById('workflow-name').innerHTML = 'Showing plot for - ' + rowElement.getElementsByTagName("td")[0].innerHTML;

    $(".calculator-costs").trigger("update");
    return 0;
  }

  function getMachineCount(calculatedSlots) {
    //function determines how many machines will be needed
    var slotMachineRatio = $('#slot-machine-ratio').val();
    var calibrationRatio = $('#calibration-machine-count').val() / (defaultSlotsCounter / slotMachineRatio);
    var utilizationRatio = $('#utilization-ratio').val();
    $('#machines-calculated').text(Math.ceil(calculatedSlots / slotMachineRatio));
    var machinesCalibrated = Math.ceil(calibrationRatio * (calculatedSlots / slotMachineRatio));
    $('#machines-calibrated').text(machinesCalibrated);
    var machinesUtilization = Math.ceil(machinesCalibrated * 100 / utilizationRatio);
    return machinesUtilization;
  }

  function makeExeFreqCellFromFreq(freq, defaultValues, displayReset) {
    var exeFreqCell = $('<td class="execution-frequency"></td>');
    var inputCount = $('<input type="number">').attr({
      value: freq.toFixed(2),
      onclick: "updateCalculationResults(this.parentNode.parentNode,'frequency')",
      onkeyup: "updateCalculationResults(this.parentNode.parentNode,'frequency')",
      onchange: "showDefaultButton(this.parentNode.childNodes[3]);" +
      "saveRowConfig(this.parentNode.parentNode, this, 'exe-freq'); saveRowConfig(this.parentNode.parentNode, this.parentNode.childNodes[2], 'time-frame')"
    });

    inputCount.attr('default', freq.toFixed(8));

    var resetDefaultButton = $('<span class="glyphicon glyphicon-repeat" aria-hidden="true"></span>')
    resetDefaultButton.attr({
      'data-toggle': "tooltip",
      'data-placement': "bottom",
      'style': "visibility: " + (displayReset ? "visible" : "hidden"),
      'title': "Default: " + defaultValues.freq.toFixed(2) + " per " + defaultValues.timeFrame,
      onclick: 'resetHandler(this.parentNode.parentNode, this.parentNode.childNodes[0], "exe-freq",' + defaultValues.freq.toFixed(2) + ');' +
      'resetHandler(this.parentNode.parentNode, this.parentNode.childNodes[2], "time-frame",' + '"' + defaultValues.timeFrame + '"' + ')'
    });//add tooltip with default value

    var selectTimeFrame = $('<select></select>').attr({
      onchange: "updateCalculationResults(this.parentNode.parentNode, 'frequency'); " +
      "showDefaultButton(this.parentNode.childNodes[3]);" +
      "saveRowConfig(this.parentNode.parentNode, this, 'time-frame');" +
      "saveRowConfig(this.parentNode.parentNode, this.parentNode.childNodes[0], 'exe-freq')"
    });
    Object.keys(TIME_CONVERT).forEach(function (timeFrame) {
      var option = $('<option></option>');
      option.append(timeFrame);
      if (timeFrame === defaultValues.timeFrame)
        option.attr('selected', 'selected');
      selectTimeFrame.append(option)
    });

    exeFreqCell.append(inputCount).append(' / ').append(selectTimeFrame)
        .append(resetDefaultButton);
    return exeFreqCell;
  }

  function computeExecutionFrequency(exeCount, dateRangeMillis) {
    var dateRangeHours = dateRangeMillis / (1000 * 60 * 60);
    return exeCount / (dateRangeHours / 24);
  }

  function getSlotRate(exeCount, slotMillis) {
    return (slotMillis / exeCount) / (1000 * 60 * 60);
  }

  //  function changeFrequency(thisInput) {
  //    var newTimeFrame = thisInput.selectedOptions.item().value;
  //    var inputFreq = thisInput.parentNode.children.item(0); //the first item in the parent cell is the input
  //    var exeFreqDefaultPerDay = inputFreq.getAttribute('default'); //the input's default (per day)
  //
  //    inputFreq.setAttribute('value', (exeFreqDefaultPerDay * TIME_CONVERT[newTimeFrame] / 24).toFixed(2));
  //    inputFreq.onchange();
  //  }

  function makeSlotCellFromSlotHoursPerExecution(slotHoursPerExecution, defaultValues, displayReset) {
    //calculates the slot hours per execution and put into cell as an input

    var cell = $('<td class="shpe"></td>');
    var inputSlotHours = $('<input type="number">').attr({
      value: slotHoursPerExecution.toFixed(2),
      onclick: "updateCalculationResults(this.parentNode.parentNode,'shpe')",
      onkeyup: "updateCalculationResults(this.parentNode.parentNode,'shpe')",
      onchange: "showDefaultButton(this.parentNode.childNodes[1]); saveRowConfig(this.parentNode.parentNode, this, 'slot-hours')"
    });

    var resetDefaultButton = $('<span class="glyphicon glyphicon-repeat" aria-hidden="true"></span>')
    resetDefaultButton.attr({
      'data-toggle': "tooltip",
      'data-placement': "bottom",
      'style': "visibility: " + (displayReset ? "visible" : "hidden"),
      'title': "Default: " + defaultValues.shpe.toFixed(2) + " Slot Hours per execution",
      onclick: 'resetHandler(this.parentNode.parentNode, this.parentNode.childNodes[0], "slot-hours",' + defaultValues.shpe + ')'
    });//this.parentNode.parentNode, this.parentNode.childNodes[1], "slot-hours", defaultValues.shpe)'}); //add tooltip with default value

    cell.append(inputSlotHours)
        .append(resetDefaultButton);
    return cell;
  }

  function computeSlotHoursPerExecution(exeCount, slotMillis) {
    return (slotMillis / exeCount) / (1000 * 60 * 60); //convert from ms to hours
  }

  function saveDateRangeConfigs() {
    startDate = absoluteStart.datepicker('getDate');
    endDate = absoluteEnd.datepicker('getDate');
    configs[startDateConfigKey] = startDate.getTime();
    configs[endDateConfigKey] = endDate.getTime();
    updateConfigsInUrl(configs);
  }

  function datePickerHandler() {
    saveDateRangeConfigs();
    refreshAbsoluteTable();
  }

  function initConfigs() {
    var rawConfigs = getParameterByName("configs");

    if (rawConfigs) {
      configs = JSON.parse(rawConfigs);
    }
  }

  function initConstants() {
    startDateConfigKey = "absolute-start-date";
    endDateConfigKey = "absolute-end-date";
    slotMachineRatioKey = "slot-machine-ratio";
    calibrationRatioKey = "calibration-machine-count";
    utilizationRatioKey = "utilization-ratio";
  }

  function initDatePicker() {
    absoluteStart = $("#" + startDateConfigKey);
    absoluteStart.datepicker({
      onSelect: datePickerHandler
    });

    absoluteEnd = $("#" + endDateConfigKey);
    absoluteEnd.datepicker({
      onSelect: datePickerHandler
    });

    absoluteEnd.datepicker("setDate", endDate);
    absoluteStart.datepicker("setDate", startDate);
  }

  function initDateRange() {
    endDate = moment().subtract(1, 'days').toDate();
    if (configs[endDateConfigKey]) {
      endDate = new Date(configs[endDateConfigKey]);
    }

    startDate = moment().subtract(60, 'days').toDate();
    if (configs[startDateConfigKey]) {
      startDate = new Date(configs[startDateConfigKey]);
    }
  }

  function saveSettingConfig(setting, name) {
    configs[name] = setting.value;
    updateConfigsInUrl(configs);
  }

  function initSettings() {
    calibrationRatio = $("#" + calibrationRatioKey);
    calibrationRatio.attr({
      onchange: "saveSettingConfig(this, calibrationRatioKey); updateMachineTable();"
    });

    slotToMachineRatio = $("#" + slotMachineRatioKey);
    slotToMachineRatio.attr({
      onchange: "saveSettingConfig(this, slotMachineRatioKey); updateMachineTable();"
    });

    utilizationRatio = $("#" + utilizationRatioKey);
    utilizationRatio.attr({
      onchange: "saveSettingConfig(this, utilizationRatioKey); updateMachineTable();"
    });
  }

  function saveSettingConfigs() {
    saveSettingConfig(calibrationRatio[0], calibrationRatioKey);
    saveSettingConfig(slotToMachineRatio[0], slotMachineRatioKey);
    saveSettingConfig(utilizationRatio[0], utilizationRatioKey);
  }

  function init() {
    initConfigs();
    initConstants();
    initDateRange();
    initDatePicker();
    refreshAbsoluteTable();
    saveDateRangeConfigs();
    initSettings();
    saveSettingConfigs();
  }

  function resetHandler(rowElement, element, name, defaultValue) {
    var workflowName = rowElement.getElementsByTagName("td").item(0).textContent;
    if (name == 'slot-hours' || name == 'exe-freq') {
      element.value = defaultValue.toFixed(2);
    } else {
      element.value = defaultValue;
    }
    clearConfig(workflowName, name);
    if (name == 'time-frame' || name == 'exe-freq') {
      element.parentNode.childNodes[3].style.visibility = 'hidden';
    } else {
      element.parentNode.childNodes[1].style.visibility = 'hidden';
    }
  }

  function clearConfig(workflowName, elementName) {
    delete configs[workflowName][elementName];
    if (isEmptyObject(configs[workflowName])) {
      delete configs[workflowName];
    }
    updateConfigsInUrl(configs);
  }

  function isEmptyObject(obj) {
    return JSON.stringify(obj) === '{}';
  }

  function refreshAbsoluteTable() {
    $('#settings-message').text(startDate.toDateString() + " to " + endDate.toDateString());

    $.ajax({
      type: 'GET',
      dataType: 'html',
      url: 'cluster_usage',
      data: {
        started_after: startDate.getTime(),
        started_before: moment(endDate).add(1, 'days').toDate().getTime()
      },
      success: function (dataStr) {
        var dateRangeMillis = moment(endDate).add(1, 'days').toDate().getTime() - startDate.getTime();

        refreshAbsoluteSuccess(dataStr, dateRangeMillis);
      }
    });
  }
  var defaultSlotsCounter;
  function refreshAbsoluteSuccess(dataStr, dateRangeMillis) {

    var parse = JSON.parse(dataStr);
    var table = $('#calc-inputs');
    table.empty();

    defaultSlotsCounter = 0;
    var maxCost = 0;
    var initPlotRow;

    console.log(parse);

    Object.keys(parse).forEach(function (e) {

      var row = $('<tr class="cost_row"></tr>');

      var app = parse[e];

      var cpuTime= 0;

      var cpu = app.counters['YarnStats.VCORES_SECONDS'];
      if (cpu) {
        cpuTime += cpu*1000;
      }

      if (e !== "CLUSTER_TOTAL") {

        var nameCell = $('<td></td>');
        var name = trimClassName(e);
        row.attr('id', name);
        var link = $('<a href="application.html?name=' + encodeURIComponent(e) + '#cost-tab"/></a>');
        link.append(name);
        nameCell.append(link);

        row.append(nameCell);

        // Look for saved configs in the url
        var freq = null, timeFrame = null, slot = null;
        if (configs[name]) {
          if (configs[name]['exe-freq']) {
            freq = configs[name]['exe-freq'];
          }
          if (configs[name]['time-frame']) {
            timeFrame = configs[name]['time-frame'];
          }
          if (configs[name]['slot-hours']) {
            slot = configs[name]['slot-hours'];
          }
        }

        var displayFreqReset = false;
        var displaySlotReset = false;

        if (freq || timeFrame) {
          displayFreqReset = true;
        }

        if (slot) {
          displaySlotReset = true;
        }

        var defaultValues = getDefaults(app.count, dateRangeMillis, cpuTime);
        defaultSlotsCounter += defaultValues.freq * defaultValues.shpe / (TIME_CONVERT[defaultValues.timeFrame]);

        // Set defaults if no configs
        if (!freq) {
          freq = defaultValues.freq;

          if (!timeFrame) {
            freq = defaultValues.freq;
            timeFrame = defaultValues.timeFrame;
          }
        }
        if (!timeFrame) {
          timeFrame = "day";
        }
        if (!slot) {
          slot = defaultValues.shpe;
        }

        row.append(makeExeFreqCellFromFreq(freq, defaultValues, displayFreqReset));
        row.append(makeSlotCellFromSlotHoursPerExecution(slot, defaultValues, displaySlotReset));
        var costCell = $('<td></td>');
        var cost = slot * app.count;
        costCell.append((slot * app.count / 1000).toFixed(2));
        row.append(costCell);
        table.append(row);

        if (maxCost < cost) {
          initPlotRow = name;
          maxCost = cost;
        }
      }
    });

    updateCalculationResults($('#' + initPlotRow).get(0), 'frequency');

    $('.calculator-costs').tablesorter({
      headers: {
        1: {
          sorter: 'frequency'
        },
        2: {
          sorter: 'shpe'
        },
      }
    });

    $(".calculator-costs").trigger("update");

    var sorting = [[3, 1]];
    $(".calculator-costs").trigger("sorton", [sorting]);

    $(document).ready(function () {
      $('[data-toggle="tooltip"]').tooltip();
      /*
       $(".calculator-costs").tablesorter({
       sortList: [[3,1]]
       });*/
    });
    calculateResources();
  }

  function convertFreqToWhole(freq) {
    //Coverts a small frequency number to a "wholer" number, ie closer to 1+ / time frame
    var MIN_SIZE = 0.95;
    var timeFrame = 'day';
    var newFreq = freq;
    if (newFreq < MIN_SIZE) {
      newFreq = newFreq * 7;
      timeFrame = 'week';
      if (newFreq < MIN_SIZE) {
        newFreq = newFreq * 30 / 7;
        timeFrame = 'month';
      }
    }

    return {freq: newFreq, timeFrame: timeFrame}
  }

  $(".spoiler-trigger").click(function () {
    $(this).parent().next().collapse('toggle');
  });

  function updateMachineTable() {
    var calculatedSlots = parseInt($('#slots-hours-needed').text());
    var slotMachineRatio = $('#slot-machine-ratio').val();
    var calibrationRatio = $('#calibration-machine-count').val() / (defaultSlotsCounter / slotMachineRatio);
    var utilizationRatio = $('#utilization-ratio').val();
    $('#machines-calculated').text(Math.ceil(calculatedSlots / slotMachineRatio));
    var machinesCalibrated = Math.ceil(calibrationRatio * (calculatedSlots / slotMachineRatio));
    $('#machines-calibrated').text(machinesCalibrated);
    var machinesUtilization = Math.ceil(machinesCalibrated * 100 / utilizationRatio);

    $('#machines-utilization').text(machinesUtilization);
    spinSlotMachine(machinesUtilization);
    $('#playBtn').click();

  }

  function getDefaults(count, dateRangeMillis, totalSlotTime) {
    var freq = computeExecutionFrequency(count, dateRangeMillis, totalSlotTime); //assumed per day
    var freqAndTimeFrame = convertFreqToWhole(freq);
    return {
      freq: freqAndTimeFrame.freq,
      timeFrame: freqAndTimeFrame.timeFrame,
      shpe: computeSlotHoursPerExecution(count, totalSlotTime)
    };
  }
  function showDefaultButton(defaultButton) {
    defaultButton.style.visibility = 'visible';
  }
  init();


</script>


</body>
</html>
